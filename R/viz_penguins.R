
# source("packages.R")

plot_decision_surface <- function(penguins, predictions, title, grid){

  # this is not a general function for plotting
  # decision surfaces. It just helps to minimize
  # copying and pasting of code.

  class_preds <- bind_cols(grid, predictions) %>%
    pivot_longer(cols = c(Adelie,
                          Chinstrap,
                          Gentoo)) %>%
    group_by(flipper_length_mm, bill_length_mm) %>%
    arrange(desc(value)) %>%
    slice(1)

  cols <- c(Adelie = "darkorange",
            Chinstrap = "purple",
            Gentoo = "cyan4")

  cols_fill <- cols[unique(class_preds$name)]

  ggplot(class_preds, aes(y = bill_length_mm,
                          x = flipper_length_mm)) +
    geom_contour_filled(aes(z = value, fill = name),
                        alpha = .25) +
    geom_point(data = penguins,
               size = 3,
               aes(color = species, shape = species),
               alpha = 0.8) +
    scale_color_manual(values = cols) +
    scale_fill_manual(values = cols_fill) +
    theme_bw() +
    labs(x = "\nFlipper length, mm",
         y = "Bill length, mm\n") +
    coord_cartesian(ylim = c(30, 70),
                    xlim = c(170, 235)) +
    theme(panel.grid = element_blank(),
          legend.position = '',
          text = element_text(size = 18))

}

viz_penguins <- function() {

  penguins <- drop_na(penguins)

  penguins$flipper_length_mm <- as.numeric(penguins$flipper_length_mm)

  fig_peng <- ggplot(data = penguins) +
    aes(x = flipper_length_mm, y = bill_length_mm, label = species) +
    geom_point(aes(color = species, shape = species),
               size = 3,
               alpha = 0.8) +
    theme_bw() +
    scale_color_manual(values = c("darkorange","purple","cyan4")) +
    scale_fill_manual(values = c("darkorange","purple","cyan4")) +
    labs(x = "\nFlipper length, mm",
         y = "Bill length, mm\n") +
    coord_cartesian(ylim = c(30, 70),
                    xlim = c(170, 235)) +
    theme(panel.grid = element_blank(),
          legend.position = '',
          text = element_text(size = 18))

  fig_demo <-  fig_peng +
    geom_mark_ellipse(aes(color = species, fill = species),
                      alpha = 0.075)

  axis_1 <- rpart(formula = species ~ flipper_length_mm + bill_length_mm,
                  data = penguins,
                  control = rpart.control(maxdepth = 1))

  axis_2 <- rpart(formula = species ~ flipper_length_mm + bill_length_mm,
                  data = penguins,
                  control = rpart.control(maxdepth = 2))

  axis_3 <- ranger(formula = species ~ flipper_length_mm + bill_length_mm,
                   data = penguins,
                   probability = TRUE)



  oblique_1 <- orsf(species ~ flipper_length_mm + bill_length_mm,
                    data = penguins,
                    split_min_obs = nrow(penguins)-1,
                    tree_seeds = 649725,
                    oobag_pred_type = 'none',
                    n_tree = 1)

  oblique_2 <- orsf(species ~ flipper_length_mm + bill_length_mm,
                    data = penguins,
                    split_min_obs = floor(nrow(penguins)/4),
                    tree_seeds = 649725,
                    oobag_pred_type = 'none',
                    n_tree = 1)

  oblique_3 <- orsf(species ~ flipper_length_mm + bill_length_mm,
                    data = penguins)

  grid <- expand_grid(
    flipper_length_mm = seq(170, 235, len = 200),
    bill_length_mm = seq(30, 70, len = 200)
  )

  pred_1 <- predict(axis_1, newdata = grid, type = 'prob')

  pred_2 <- predict(axis_2, newdata = grid, type = 'prob')

  pred_3 <- predict(axis_3, data = grid)$predictions

  pred_4 <- predict(oblique_1, new_data = grid, pred_type = 'prob')

  pred_5 <- predict(oblique_2, new_data = grid, pred_type = 'prob')

  pred_6 <- predict(oblique_3, new_data = grid, pred_type = 'prob')

  p1 <- plot_decision_surface(penguins,
                              predictions = pred_1,
                              title = '',
                              grid = grid)

  p2 <- plot_decision_surface(penguins,
                              predictions = pred_2,
                              title = '',
                              grid = grid)

  p3 <- plot_decision_surface(penguins,
                              predictions = pred_3,
                              title = '',
                              grid = grid)

  p4 <- plot_decision_surface(penguins,
                              predictions = pred_4,
                              title = '',
                              grid = grid)

  p5 <- plot_decision_surface(penguins,
                              predictions = pred_5,
                              title = '',
                              grid = grid)

  p6 <- plot_decision_surface(penguins,
                              predictions = pred_6,
                              title = '',
                              grid = grid)

  list(demo = fig_demo,
       axis_1 = p1,
       axis_2 = p2,
       axis_3 = p3,
       oblique_1 = p4,
       oblique_2 = p5,
       oblique_3 = p6)

}






# fig_axis_1 <- fig_peng +
#   geom_parttree(data = axis_1, aes(fill=species),
#                 alpha = 0.1) +
#   scale_fill_manual(values = c("darkorange","cyan4"))
#
# axis_2 <- rpart(formula = species ~ flipper_length_mm + bill_length_mm,
#                 data = penguins,
#                 control = rpart.control(maxdepth = 2))
#
# fig_axis_2 <- fig_peng +
#   geom_parttree(data = axis_2, aes(fill=species),
#                 alpha = 0.1)
